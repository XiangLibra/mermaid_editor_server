<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mermaid + CSS å³æ™‚ç·¨è¼¯å™¨ï¼ˆTabs + KROKIï¼‰</title>

  <!-- ç”¨æ–¼å£“ç¸® Mermaid ç¨‹å¼ç¢¼ï¼ˆKroki éœ€è¦ deflate + base64ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/pako@2.0.4/dist/pako.min.js"></script>

  <script>
    // ====== å³æ™‚æ¸²æŸ“ ======
    function renderMermaid() {
      const code = document.getElementById("mermaidInput").value;
      const css = document.getElementById("customCssInput").value;
      const chartFrame = document.getElementById("chartFrame");
      if (chartFrame && chartFrame.contentWindow) {
        chartFrame.contentWindow.postMessage({
          action: "render",
          code,
          css
        }, "*");
      }
    }

    function copySVG() {
    // è·Ÿå­é é¢è¦ "SVG å­—ä¸²"
    const chartFrame = document.getElementById("chartFrame");
    chartFrame.contentWindow.postMessage({ action: "requestSVG" }, "*");
    }

    function copyPNG() {
      // è·Ÿå­é é¢è¦ "PNG base64"
      const chartFrame = document.getElementById("chartFrame");
      chartFrame.contentWindow.postMessage({ action: "requestPNG" }, "*");
    }


    // ====== ä¸‹è¼‰æŒ‰éˆ• ======
    function downloadSVG() {
      const chartFrame = document.getElementById("chartFrame");
      if (chartFrame && chartFrame.contentWindow) {
        chartFrame.contentWindow.postMessage({ action: "downloadSVG" }, "*");
      }
    }
    function downloadPNG() {
      const chartFrame = document.getElementById("chartFrame");
      if (chartFrame && chartFrame.contentWindow) {
        chartFrame.contentWindow.postMessage({ action: "downloadPNG" }, "*");
      }
    }

    // å°ˆé–€ç”¨ä¾†å‘ chartFrame postMessage
    function postToChart(action) {
    const chartFrame = document.getElementById("chartFrame");
    if (chartFrame && chartFrame.contentWindow) {
        chartFrame.contentWindow.postMessage({ action }, "*");
        }
    }   

    // æŒ‰éˆ•äº‹ä»¶ï¼šåŒ¯å‡º SVG
    function exportSVG() {
    postToChart("exportSVG");
    }

    // æŒ‰éˆ•äº‹ä»¶ï¼šåŒ¯å‡º PNG
    function exportPNG() {
    postToChart("exportPNG");
    }


    // ====== é–‹å•Ÿ Kroki ======
    function openKroki() {
      const code = document.getElementById("mermaidInput").value.trim();
      const data = new TextEncoder().encode(code); 
      const compressed = pako.deflate(data, { level: 9 });
      let binaryStr = "";
      for (let i = 0; i < compressed.length; i++) {
        binaryStr += String.fromCharCode(compressed[i]);
      }
      let base64 = btoa(binaryStr);
      base64 = base64
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, ""); // ç§»é™¤çµå°¾çš„ '='

      const url = `https://kroki.io/mermaid/svg/${base64}`;
      window.open(url, "_blank");
    }

    function copyKrokiURL() {
      const code = document.getElementById("mermaidInput").value.trim();
      const data = new TextEncoder().encode(code);
      const compressed = pako.deflate(data, { level: 9 });

      let binaryStr = "";
      for (let i = 0; i < compressed.length; i++) {
        binaryStr += String.fromCharCode(compressed[i]);
      }
      let base64 = btoa(binaryStr);
      base64 = base64
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");

      const url = `https://kroki.io/mermaid/svg/${base64}`;

      // è¤‡è£½åˆ°å‰ªè²¼ç°¿
      navigator.clipboard.writeText(url)
        .then(() => {
          showToast("å·²è¤‡è£½ KROKI ç¶²å€åˆ°å‰ªè²¼ç°¿ï¼");
        })
        .catch((err) => {
          console.error("è¤‡è£½ KROKI ç¶²å€å¤±æ•—:", err);
          alert("è¤‡è£½å¤±æ•—ï¼Œè«‹ç¢ºèªç€è¦½å™¨æˆ– HTTPS ç’°å¢ƒã€‚");
        });
    }


    // ====== Tabs åˆ‡æ› ======
    function showMermaidTab() {
      document.getElementById("mermaidTab").classList.add("active");
      document.getElementById("cssTab").classList.remove("active");

      document.getElementById("mermaidInput").classList.remove("hidden");
      document.getElementById("customCssInput").classList.add("hidden");
    }
    function showCssTab() {
      document.getElementById("cssTab").classList.add("active");
      document.getElementById("mermaidTab").classList.remove("active");

      document.getElementById("customCssInput").classList.remove("hidden");
      document.getElementById("mermaidInput").classList.add("hidden");
    }
  
    // ====== Lifecycle ======
    window.addEventListener("DOMContentLoaded", () => {
      const chartFrame = document.getElementById("chartFrame");
      chartFrame.onload = () => {
        renderMermaid();
      };
      // DOMContentLoaded æ™‚ä¹Ÿå˜—è©¦
      renderMermaid();

      // ç•¶ Mermaid æˆ– CSS å€æ–‡å­—è®Šæ›´æ™‚ï¼Œå³æ™‚æ›´æ–°åœ–è¡¨
      document.getElementById("mermaidInput")
              .addEventListener("input", renderMermaid);
      document.getElementById("customCssInput")
              .addEventListener("input", renderMermaid);

    //è¤‡è£½æŒ‰éˆ•
      document.getElementById("btnCopySVG").addEventListener("click", copySVG);
      document.getElementById("btnCopyPNG").addEventListener("click", copyPNG);       
      // ä¸‹è¼‰æŒ‰éˆ•
      document.getElementById("btnDownloadSVG").addEventListener("click", downloadSVG);
      document.getElementById("btnDownloadPNG").addEventListener("click", downloadPNG);
        // ç¶å®šåŒ¯å‡ºæŒ‰éˆ•äº‹ä»¶ (å‡è¨­ä½ åœ¨ DOMContentLoaded ä¸­åš)
    document.getElementById("btnExportSVG").addEventListener("click", exportSVG);
    document.getElementById("btnExportPNG").addEventListener("click", exportPNG);

      // Kroki æŒ‰éˆ•
      document.getElementById("btnKroki").addEventListener("click", openKroki);
        // â˜…  KROKIç¶²å€ æŒ‰éˆ• â†’ copyKrokiURL
      document.getElementById("btnKrokiURL").addEventListener("click", copyKrokiURL);

      // Tabs
      document.getElementById("mermaidTab").addEventListener("click", showMermaidTab);
      document.getElementById("cssTab").addEventListener("click", showCssTab);

      // é è¨­é¡¯ç¤º Mermaid å€åŸŸ
      showMermaidTab();
    });

      // çˆ¶é é¢æ¥æ”¶å­é é¢å›å‚³
    window.addEventListener("message", async (e) => {
      const data = e.data;
      if (!data) return;

      // æ”¶åˆ° "responseSVG" { type:"responseSVG", svg:... }
      if (data.type === "responseSVG") {
        try {
          await navigator.clipboard.writeText(data.svg);
          showToast("æ–‡å­—åˆ°å‰ªè²¼ç°¿");
        } catch (err) {
          console.error("è¤‡è£½ SVG å¤±æ•—:", err);
          alert("è¤‡è£½ SVG å¤±æ•—ï¼Œç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´æˆ–æœªåœ¨å®‰å…¨ç’°å¢ƒ");
        }
      }
      // æ”¶åˆ° "responsePNG" { type:"responsePNG", png:... } => dataURL
      else if (data.type === "responsePNG") {
        try {
          const res = await fetch(data.png); // data.png ç‚º "data:image/png;base64,xxx"
          const blob = await res.blob(); // => image/png
          const item = new ClipboardItem({ "image/png": blob });
          await navigator.clipboard.write([item]);
          showToast("å·²è¤‡è£½ PNG åœ–ç‰‡åˆ°å‰ªè²¼ç°¿");
        } catch (err) {
          console.error("è¤‡è£½ PNG å¤±æ•—:", err);
          alert("è¤‡è£½ PNG å¤±æ•—ï¼Œç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ Clipboard API æˆ–æœªåœ¨ HTTPS");
        }
      }
    });



        function showToast(message) {
      // å»ºç«‹ä¸€å€‹ <div> ä½œç‚ºæç¤ºå®¹å™¨
      const toast = document.createElement("div");
      toast.textContent = message;
      
      // è¨­å®šä¸€äº›ç°¡æ˜“æ¨£å¼
      toast.style.position = "fixed";
      toast.style.bottom = "20px";
      toast.style.right = "20px";
      toast.style.zIndex = 9999;
      toast.style.backgroundColor = "#008080";
      toast.style.color = "#FFFFFF";
      toast.style.padding = "10px 20px";
      toast.style.borderRadius = "5px";
      toast.style.fontSize = "14px";
      toast.style.opacity = "0"; // èµ·å§‹ä¸é€æ˜åº¦
      
      document.body.appendChild(toast);

      // é€æ¼¸æ·¡å…¥
      setTimeout(() => {
        toast.style.transition = "opacity 0.3s";
        toast.style.opacity = "1";
      }, 0);

      // å¹¾ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        // å…ˆæ·¡å‡º
        toast.style.opacity = "0";
        // ç­‰æ·¡å‡ºå‹•ç•«çµæŸå¾Œï¼Œå†ç§»é™¤å…ƒç´ 
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 2000); // 2 ç§’å¾Œè‡ªå‹•é—œé–‰
    }

  </script>

  <style>
    /* ========== ç‰ˆé¢é…ç½® ========== */
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    /* å·¦å´ç·¨è¼¯å™¨å€ */
    #editor {
      width: 30%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      border-right: 3px solid #ccc;
    }
    /* åˆ†éš”æ¢(å¯æ‹–æ›³) */
    #resizer {
      width: 10px;
      cursor: ew-resize;
      background-color: #ddd;
    }
    /* å³å´ iframe å€ */
    #output {
      flex: 1;
      display: block;
      background-color: #f9f9f9;
      overflow: hidden;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* ========== Tabs æ¨£å¼ ========== */
    .tabs {
      display: flex;
      background-color: #2d2d2d;  /* é¡ä¼¼ VSCode é¡è‰² */
      padding: 0 10px;
    }
    .tabs button {
      background: none;
      border: none;
      color: #ccc;
      font-size: 14px;
      margin: 0;
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tabs button:hover {
      color: #fff;
      background-color: #3c3c3c;
    }
    .tabs button.active {
      color: #fff;
      border-bottom: 2px solid #007acc; /* VSCode è—è‰² */
      font-weight: bold;
    }

    /* ========== Textarea å€åŸŸ ========== */
    .editor-container {
      flex: 1;  /* è®“ä¸­é–“å€å¡Šå¯æ’é–‹ */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    textarea {
      flex: 1;
      border: none;
      font-size: 14px;
      font-family: monospace;
      box-sizing: border-box;
      padding: 10px;
      resize: none;
      width: 100%;
    }
    /* hidden ç”¨æ–¼åˆ‡æ›é¡¯ç¤º/éš±è— */
    .hidden {
      display: none !important;
    }

    /* ========== åº•éƒ¨ä¸‹è¼‰æŒ‰éˆ•(å«Kroki) ========== */
    .buttons-grid {
  display: grid;
  /* å››æ¬„ Ã— å…©åˆ—ï¼Œå…± 8 æ ¼ */
  grid-template-columns: repeat(4, 1fr);
  grid-template-rows: repeat(2, auto);
  
  gap: 10px;
  padding: 10px;
}

/* ç¬¬ä¸€åˆ— 4 é¡† (row=1) */
.item1 { grid-column: 1; grid-row: 1; }
.item2 { grid-column: 2; grid-row: 1; }
.item3 { grid-column: 3; grid-row: 1; }
.itemKroki { grid-column: 4; grid-row: 1; }

/* ç¬¬äºŒåˆ— 4 é¡† (row=2) */
.item4        { grid-column: 1; grid-row: 2; }
.item5        { grid-column: 2; grid-row: 2; }
.item6        { grid-column: 3; grid-row: 2; }
/* â˜… æ–°å¢ itemKrokiURL */
.itemKrokiURL { grid-column: 4; grid-row: 2; }

.buttons-grid button {
  font-size: 14px;
  border: none;
  background-color: #007bff;
  color: white;
  border-radius: 0px;
  cursor: pointer;
  transition: background-color 0.2s;
  padding: 3px 3px;
}
.buttons-grid button:hover {
  background-color: #0056b3;
}


  </style>
</head>

<body>
  <!-- å·¦å´ï¼šç·¨è¼¯å™¨(åŒ…å« Tabsã€ç·¨è¼¯å™¨å®¹å™¨ã€åº•éƒ¨ä¸‰å€‹æŒ‰éˆ•) -->
  <div id="editor">
    <!-- Tabs (Mermaid / CSS) -->
    <div class="tabs">
      <button id="mermaidTab" class="tab">Mermaid</button>
      <button id="cssTab" class="tab">CSS</button>
    </div>

    <!-- ä¸­é–“ textarea å€ (å¯é¡¯ç¤º/éš±è—) -->
    <div class="editor-container">
      <textarea id="mermaidInput">
gantt
  title AI å¤šæ¨¡æ…‹è¾¨è­˜å°ˆæ¡ˆ
  dateFormat YYYY-MM-DD
  section ç ”ç©¶éšæ®µ
  æ–‡ç»å›é¡§èˆ‡è³‡æ–™æ•´ç†   :done, 2025-02-01, 60d
  è³‡æ–™å‰è™•ç†èˆ‡æ¨¡å‹å»ºæ§‹ :active, 2025-04-01, 90d
  section é–‹ç™¼éšæ®µ
  å‰ç«¯ä»‹é¢è¨­è¨ˆ       :b1, 2025-06-01, 60d
  å¾Œç«¯ API ä¸²æ¥     :b2, 2025-07-01, 90d
      </textarea>

      <textarea id="customCssInput" class="hidden">
/* åœ¨æ­¤è¼¸å…¥è‡ªè¨‚CSSï¼Œä¾‹å¦‚ï¼š
.node rect {
  fill: #ffff99 !important;
  stroke: #ff0000 !important;
  stroke-width: 3px !important;
}
*/
      </textarea>
    </div>

   


    <!-- ç¯„ä¾‹ HTML çµæ§‹ï¼šå…©åˆ— Ã— å››æ¬„, å…± 8 é¡†æŒ‰éˆ• -->
    <div class="buttons-grid">
      <!-- ç¬¬ä¸€è¡Œ (row=1) -->
      <button id="btnCopySVG"     class="item1">ğŸ“‹ è¤‡è£½ SVG</button>
      <button id="btnDownloadSVG" class="item2">â¬‡ï¸ ä¸‹è¼‰ SVG</button>
      <button id="btnExportSVG"   class="item3">ğŸ“¤ åŒ¯å‡º SVG</button>
      <button id="btnKroki"       class="itemKroki">âš¡ KROKI</button>
      
      <!-- ç¬¬äºŒè¡Œ (row=2) -->
      <button id="btnCopyPNG"     class="item4">ğŸ“‹ è¤‡è£½ PNG</button>
      <button id="btnDownloadPNG" class="item5">â¬‡ï¸ ä¸‹è¼‰ PNG</button>
      <button id="btnExportPNG"   class="item6">ğŸ“¤ åŒ¯å‡º PNG</button>
      <!-- â˜… æ–°å¢ KROKIç¶²å€ æŒ‰éˆ• (row=2,col=4) -->
      <button id="btnKrokiURL"    class="itemKrokiURL">ğŸ”— KROKIç¶²å€</button>
    </div>

    
    <!-- ä½ åŸæœ¬çš„å…¶ä»–å€å¡Šçµæ§‹ä¿æŒä¸è®Šï¼Œåƒ…ä¿®æ”¹/æ›¿æ›åº•éƒ¨æŒ‰éˆ•å€å¦‚ä¸‹ -->

  </div>

  


  <!-- åˆ†éš”æ¢(æ‹–æ›³) -->
  <div id="resizer"></div>

  <!-- å³å´ï¼šiframe é¡¯ç¤ºåœ–è¡¨ -->
  <div id="output">
    <iframe id="chartFrame" src="chart.html"></iframe>
  </div>

  <script>
    // ====== æ‹–æ›³åˆ†éš”æ¢ ======
    const resizer = document.getElementById("resizer");
    const editor = document.getElementById("editor");
    let isResizing = false;

    resizer.addEventListener("mousedown", () => {
      isResizing = true;
      document.body.style.cursor = "ew-resize";
    });

    document.addEventListener("mousemove", (e) => {
      if (!isResizing) return;
      const editorWidth = e.clientX;
      const minWidth = 300;
      const maxWidth = window.innerWidth - 300;
      if (editorWidth > minWidth && editorWidth < maxWidth) {
        editor.style.width = editorWidth + "px";
      }
    });

    document.addEventListener("mouseup", () => {
      if (isResizing) {
        isResizing = false;
        document.body.style.cursor = "default";
      }
    });
  </script>
</body>
</html>
